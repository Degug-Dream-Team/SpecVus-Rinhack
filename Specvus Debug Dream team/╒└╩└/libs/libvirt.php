<?php <?php class libVirt{public function get_loading_time(){return number_format(microtime(true)-$_SERVER["REQUEST_TIME_FLOAT"],4);}public function secure_password($j0){if($j0){return base64_encode(str_rot13($j0));}return false;}public function restore_password($j0){if($j0){return base64_decode(str_rot13($j0));}return false;}private function ppm_to_png($d1,$v2=100,$s3=null){$a4=new PpmImageReader();if($v2===100){$g5=0;}else{$g5=intval(($v2/100*10));}if($a4->canRead($d1)===true){$l6=$a4->read($d1);if(!is_null($s3)){imagepng($l6[1],$s3,$g5);}else{return $l6;}}return false;}private function ppm_to_jpg($d1,$v2=100,$s3=null){$a4=new PpmImageReader();if($a4->canRead($d1)===true){$l6=$a4->read($d1);if(!is_null($s3)){imagejpeg($l6[1],$s3,$v2);}else{return $l6;}}return false;}public function virsh_shell_exec($l7){$k8='virsh';$p9=escapeshellcmd($k8.' '.$l7);$c10='2>&1';return trim(shell_exec($p9.' '.$c10));}public function virsh_exec($l7,&$s3,&$t11){$k8='virsh';$p9=escapeshellcmd($k8.' '.$l7);$c10='2>&1';exec($p9.' '.$c10,$s3,$t11);}public function virsh_exec_notify($l7,&$s3,&$t11){$k8='virsh';$p9=escapeshellcmd($k8.' '.$l7);$c10='2>&1';exec($p9.' '.$c10,$s3,$t11);foreach($s3 as $p12){if(!empty($p12)){if(strpos($p12,'error:')!==false){$this->notify($p12,true);}else{$this->notify($p12);}}}}public function virsh_passthru($l7,&$t11=null){$k8='virsh';$p9=escapeshellcmd($k8.' '.$l7);$c10='2>&1';passthru($p9.' '.$c10,$t11);}public function virsh_connect($x13='qemu:///system',$l14=false){$s3=null;$t11=null;$this->virsh_exec('connect --name '.$x13.($l14===true?' --readonly':''),$s3,$t11);if($t11!==0){$_SESSION['connected']=false;$this->notify('Could not connect to the hypervisor.',true);}else{$_SESSION['connected']=true;$this->notify('Connected to the hypervisor.');}$this->notify('Connection URI: '.$x13);return $_SESSION['connected'];}public function exec_cmd($l7,&$s3,&$t11,$c15=false){$p9=escapeshellcmd($l7);$c10='2>&1';$a16=($c15===true?' &':'');exec($p9.' '.$c10.$a16,$s3,$t11);}public function exec_cmd_notify($l7,&$s3,&$t11,$c15=false){$p9=escapeshellcmd($l7);$c10='2>&1';$a16=($c15===true?' &':'');exec($p9.' '.$c10.$a16,$s3,$t11);foreach($s3 as $p12){if(!empty($p12)){if(strpos($p12,'error:')!==false){$this->notify($p12,true);}else{$this->notify($p12);}}}}public function passthru_cmd($l7,&$t11=null,$c15=false){$p9=escapeshellcmd($l7);$c10='2>&1';$a16=($c15===true?' &':'');passthru($p9.' '.$c10.$a16,$t11);}public function shell_exec_cmd($l7,$c15=false){$p9=escapeshellcmd($l7);$c10='2>&1';$a16=($c15===true?' &':'');return trim(shell_exec($p9.' '.$c10.$a16));}public function notify($h17,$w18=false){if(!empty($h17)){if($w18!==false){$this->add_notification($h17,true);}else{$this->add_notification($h17);}}}public function add_notification($l19,$w18=false){if($w18===false){$q20=array_push($_SESSION['notifications']->$s21,$l19);}else{$q20=array_push($_SESSION['notifications']->$f22,$l19);}return $q20;}public function create_notification(&$l19,$h23=4000){if(!is_array($l19)){echo '<script type="text/javascript">';echo 'Materialize.toast("'.$l19.'", '.$h23.', "rounded");';echo '</script>';}else{$w24=0;foreach($l19 as $u25){$t26=trim($u25);if(!empty($t26)){echo '<script type="text/javascript">';echo 'Materialize.toast("'.$t26.'", '.$h23.', "rounded");';echo '</script>';}unset($l19[$w24]);$w24++;}}}public function create_error_notification(&$l19,$h23=4000){if(!is_array($l19)){echo '<script type="text/javascript">';echo 'var toastContent = $(\'<span style="color: #f44336; font-weight: bold;">'.$l19.'</span>\');';echo 'Materialize.toast(toastContent, '.$h23.', "rounded");';echo '</script>';}else{$w24=0;foreach($l19 as $u25){$t26=trim($u25);if(!empty($t26)){echo '<script type="text/javascript">';echo 'var toastContent = $(\'<span style="color: #f44336; font-weight: bold;">'.$t26.'</span>\');';echo 'Materialize.toast(toastContent, '.$h23.', "rounded");';echo '</script>';}unset($l19[$w24]);$w24++;}}}private function extract_data($p12,$b27){$p12=trim($p12);$l19=explode($b27,$p12);$l19=array_filter($l19);return $l19;}public function parse_vm_stats($m28,$v29=false,$v30=false){$l31=1;$l32='';$q33='';$y34=[];$e35=[];$this->virsh_exec('domstats --raw '.$m28,$l32,$q33);if($q33===0){$d36=0;$u37=0;foreach($l32 as $p12){$d36++;if($d36>$l31&&!empty($p12)){$u37++;$m38=$this->extract_data($p12,'.');array_push($e35,$m38[0]);}}$e35=array_unique($e35);array_merge($y34,$e35);$d36=0;$u37=0;foreach($l32 as $p12){$d36++;if($d36>$l31&&!empty($p12)){$u37++;$z39=$this->extract_data($p12,'.');$m38=$this->extract_data($p12,'=');if(count($m38)===2){$j40=['name'=>$m38[0],'value'=>$m38[1]];$y34[$z39[0]][]=$j40;}}}if($v29===true){if($v30===true){$y41=json_encode($y34,JSON_NUMERIC_CHECK|JSON_UNESCAPED_SLASHES|JSON_PRETTY_PRINT);}else{$y41=json_encode($y34,JSON_NUMERIC_CHECK|JSON_UNESCAPED_SLASHES);}return $y41;}else{return $y34;}}return false;}public function get_vm_stats($m28,$t42,$v29=false,$v30=false){$r43='';switch($t42){case 'cpu':$r43='vcpu';break;case 'Диск':$r43='block';break;case 'Память':$r43='balloon';break;case 'Сеть':$r43='net';break;default:break;}if($t44=$this->parse_vm_stats($m28)){$n45=[];foreach($t44[$r43]as $l19){$q46=explode('.',$l19['name']);if(count($q46)===2){$x47=['name'=>$q46[1],'value'=>(is_numeric($l19['value'])?(int)$l19['value']:$l19['value'])];}else{$x47=['name'=>$l19['name'],'value'=>(is_numeric($l19['value'])?(int)$l19['value']:$l19['value'])];}array_push($n45,$x47);}if($v29===true){if($v30===true){$y41=json_encode($n45,JSON_NUMERIC_CHECK|JSON_UNESCAPED_SLASHES|JSON_PRETTY_PRINT);}else{$y41=json_encode($n45,JSON_NUMERIC_CHECK|JSON_UNESCAPED_SLASHES);}return $y41;}else{return $n45;}}return false;}public function get_vm_networks(){$s3=null;$t11=null;$l31=2;$d36=0;$y34=[];$u48=[];$this->virsh_exec('net-list',$s3,$t11);foreach($s3 as $p12){$d36++;if($d36>$l31&&!empty($p12)){$y34=$this->extract_data($p12,' ');array_push($u48,$y34[0]);}}return(count($u48)>0?$u48:false);}public function get_vm_pools(){$s3=null;$t11=null;$l31=2;$d36=0;$y34=[];$z49=[];$this->virsh_exec('pool-list',$s3,$t11);foreach($s3 as $p12){$d36++;if($d36>$l31&&!empty($p12)){$y34=$this->extract_data($p12,' ');array_push($z49,$y34[0]);}}return(count($z49)>0?$z49:false);}public function get_vm_uid($m28){if(!$m28){return false;}return $this->virsh_shell_exec('domuuid '.$m28);}public function get_vm_state($m28){if(!$m28){return false;}return $this->virsh_shell_exec('domstate '.$m28);}public function create_vm_screenshots($m28,$d50=false){$j51='/tmp/'.$m28.'_screen.ppm';$p52='/tmp/'.$m28.'_screen.png';passthru(escapeshellcmd('virsh screenshot '.$m28.' --file '.$j51.' --screen 0').' 2>&1 >/dev/null');if(is_readable($j51)){$this->ppm_to_png($j51,80,$p52);if(is_readable($p52)){if($d50===true){return 'data:image/png;base64,'.base64_encode(file_get_contents($p52));}else{echo '<img class="materialboxed" src="data:image/png;base64,'.base64_encode(file_get_contents($p52)).'" width="80" alt="'.$m28.' screenshot">';}}}else{echo 'Could not read screenshot.';}}public function create_table_active_vms_rows($o53,$b27=' ',$i54=0,$e55=''){$l31=2;$d36=0;$d56=0;$y34=[];$p57=1;$q58=2;$u59=3;foreach($o53 as $p12){$d36++;if($d36>$l31&&!empty($p12)){echo '<tr>'.PHP_EOL;$y34=$this->extract_data($p12,$b27);foreach($y34 as $l19){$d56++;$f60=trim($l19);if($d56===$p57){if($f60!=='-'){$g61=(int)$f60;}}if($d56===$q58){$m28=$f60;echo '<td><a href="?module=vmi&name='.$f60.'">'.$f60.'</a></td>'.PHP_EOL;}elseif($d56===$u59){echo '<td>'.($f60==='shut off'?'not running':$f60).'&nbsp;'.PHP_EOL;if($f60==='shut off'){echo '<a href="?module='.$_SESSION['module'].'&action=start&name='.$m28.'" class="tooltipped" data-position="bottom" data-tooltip="Start"><i class="material-icons">play_arrow</i></a>'.PHP_EOL;}else{echo '<a href="?module='.$_SESSION['module'].'&action=stop&name='.$m28.'" class="tooltipped" data-position="bottom" data-tooltip="Stop"><i class="material-icons">stop</i></a>'.PHP_EOL;if($f60==='paused'){echo '<a href="?module='.$_SESSION['module'].'&action=resume&name='.$m28.'" class="tooltipped" data-position="bottom" data-tooltip="Resume"><i class="material-icons">play_arrow</i></a>'.PHP_EOL;}else{echo '<a href="?module='.$_SESSION['module'].'&action=suspend&name='.$m28.'" class="tooltipped" data-position="bottom" data-tooltip="Suspend"><i class="material-icons">pause</i></a>'.PHP_EOL;}echo '<a href="?module='.$_SESSION['module'].'&action=reboot&name='.$m28.'" class="tooltipped" data-position="bottom" data-tooltip="Reboot"><i class="material-icons">replay</i></a>'.PHP_EOL;}echo '</td>'.PHP_EOL;echo '<td class="live-preview" data-vm="'.$m28.'">'.PHP_EOL;$this->create_vm_screenshots($m28);echo '</td>'.PHP_EOL;echo '<td>'.PHP_EOL;echo '<a href="?module='.$_SESSION['module'].'&action=view&name='.$m28.'" class="tooltipped" data-position="bottom" data-tooltip="View"><i class="material-icons">personal_video</i></a>'.PHP_EOL;echo '</td>'.PHP_EOL;}else{echo '<td>'.$f60.'</td>'.PHP_EOL;}}echo '</tr>'.PHP_EOL;$d56=0;}}if(count($y34)===0){echo '<tr><td'.($i54>0?' colspan="'.$i54.'"':'').($e55!==''?' class="'.$e55.'"':'').'>No data</td></td>'.PHP_EOL;}}public function create_table_generic_rows($o53,$b27=' ',$i54=0,$e55=''){$l31=2;$d36=0;$y34=[];foreach($o53 as $p12){$d36++;if($d36>$l31&&!empty($p12)){echo '<tr>'.PHP_EOL;$y34=$this->extract_data($p12,$b27);foreach($y34 as $l19){echo '<td>'.trim($l19).'</td>'.PHP_EOL;}echo '</tr>'.PHP_EOL;}}if(count($y34)===0){echo '<tr><td'.($i54>0?' colspan="'.$i54.'"':'').($e55!==''?' class="'.$e55.'"':'').'>No data</td></td>'.PHP_EOL;}}public function create_table_active_ips_rows($o53,$b27=' ',$i54=0,$e55=''){$l31=2;$d36=0;$d56=0;$y34=[];$s62=2;$g63=4;$w64=5;foreach($o53 as $p12){$d36++;if($d36>$l31&&!empty($p12)){echo '<tr>'.PHP_EOL;$y34=$this->extract_data($p12,$b27);foreach($y34 as $l19){$d56++;$f60=trim($l19);if($d56===$s62){echo '<td>'.$f60.'</td>'.PHP_EOL;}elseif($d56===$g63){echo '<td>'.$f60.'</td>'.PHP_EOL;}elseif($d56===$w64){if($f60!=='-'){$e65=explode(' ',$f60);$p66=$e65[0];$j67='';if(count($e65)>1){$j67=$e65[1];}if(!empty($j67)){echo '<td>'.$p66.'</td>'.PHP_EOL;echo '<td>'.$j67.'</td>'.PHP_EOL;}else{echo '<td>'.$p66.'</td>'.PHP_EOL;}}else{echo '<td>'.$f60.'</td>'.PHP_EOL;}}else{echo '<td>'.$f60.'</td>'.PHP_EOL;}}echo '</tr>'.PHP_EOL;$d56=0;}}if(count($y34)===0){echo '<tr><td'.($i54>0?' colspan="'.$i54.'"':'').($e55!==''?' class="'.$e55.'"':'').'>No data</td></td>'.PHP_EOL;}}public function create_table_vms_rows($o53,$b27=' ',$i54=0,$e55=''){$l31=2;$d36=0;$d56=0;$y34=[];$p57=1;$q58=2;$u59=3;foreach($o53 as $p12){$d36++;if($d36>$l31&&!empty($p12)){echo '<tr>'.PHP_EOL;$y34=$this->extract_data($p12,$b27);foreach($y34 as $l19){$d56++;$f60=trim($l19);if($d56===$p57){if($f60!=='-'){$g61=(int)$f60;}}if($d56===$q58){$m28=$f60;echo '<td><a href="?module=vmi&name='.$f60.'">'.$f60.'</a></td>'.PHP_EOL;}elseif($d56===$u59){echo '<td>'.($f60==='shut off'?'not running':$f60).'&nbsp;'.PHP_EOL;if($f60==='shut off'){echo '<a href="?module='.$_SESSION['module'].'&action=start&name='.$m28.'" class="tooltipped" data-position="bottom" data-tooltip="Start"><i class="material-icons">play_arrow</i></a>'.PHP_EOL;}else{echo '<a href="?module='.$_SESSION['module'].'&action=stop&name='.$m28.'" class="tooltipped" data-position="bottom" data-tooltip="Stop"><i class="material-icons">stop</i></a>'.PHP_EOL;if($f60==='paused'){echo '<a href="?module='.$_SESSION['module'].'&action=resume&name='.$m28.'" class="tooltipped" data-position="bottom" data-tooltip="Resume"><i class="material-icons">play_arrow</i></a>'.PHP_EOL;}else{echo '<a href="?module='.$_SESSION['module'].'&action=suspend&name='.$m28.'" class="tooltipped" data-position="bottom" data-tooltip="Suspend"><i class="material-icons">pause</i></a>'.PHP_EOL;}echo '<a href="?module='.$_SESSION['module'].'&action=reboot&name='.$m28.'" class="tooltipped" data-position="bottom" data-tooltip="Reboot"><i class="material-icons">replay</i></a>'.PHP_EOL;}echo '</td>'.PHP_EOL;echo '<td class="live-preview" data-vm="'.$m28.'">'.PHP_EOL;if($f60!=='shut off'){$this->create_vm_screenshots($m28);}else{echo 'N/A'.PHP_EOL;}echo '</td>'.PHP_EOL;echo '<td>'.PHP_EOL;echo '<a href="?module='.$_SESSION['module'].'&action=snap&name='.$m28.'" class="tooltipped" data-position="bottom" data-tooltip="Create snapshot"><i class="material-icons">save</i></a>'.PHP_EOL;echo '<a href="?module='.$_SESSION['module'].'&action=edit&name='.$m28.'" class="tooltipped" data-position="bottom" data-tooltip="Edit"><i class="material-icons">edit</i></a>'.PHP_EOL;echo '<a href="?module='.$_SESSION['module'].'&action=delete&name='.$m28.'" class="tooltipped" data-position="bottom" data-tooltip="Delete"><i class="material-icons">delete</i></a>'.PHP_EOL;echo '<a href="#more-action-modal-vm_'.$this->get_vm_uid($m28).'" class="modal-trigger tooltipped" data-position="bottom" data-tooltip="More actions"><i class="material-icons">more_vert</i></a>'.PHP_EOL;echo '<div id="more-action-modal-vm_'.$this->get_vm_uid($m28).'" class="modal bottom-sheet">'.PHP_EOL;echo '<div class="modal-content">'.PHP_EOL;echo '<h4>'.$m28.' - advanced</h4>'.PHP_EOL;echo '<div class="row">'.PHP_EOL;echo '<div class="col s6">'.PHP_EOL;echo '<ul>'.PHP_EOL;echo '<li><a href="?module='.$_SESSION['module'].'&action=clone&name='.$m28.'" class="tooltipped" data-position="right" data-tooltip="Clone the VM"><i class="material-icons">save</i> Clone</a></li>'.PHP_EOL;echo '<li><a href="?module='.$_SESSION['module'].'&action=prep&name='.$m28.'" class="tooltipped" data-position="right" data-tooltip="Clean the cloned guest"><i class="material-icons">refresh</i> SysPrep</a></li>'.PHP_EOL;echo '</ul>'.PHP_EOL;echo '</div>'.PHP_EOL;echo '<div class="col s6">'.PHP_EOL;echo '<p>GRAPH</p>'.PHP_EOL;echo '</div>'.PHP_EOL;echo '</div>'.PHP_EOL;echo '</div>'.PHP_EOL;echo '<div class="modal-footer">'.PHP_EOL;echo '<a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Close</a>'.PHP_EOL;echo '</div>'.PHP_EOL;echo '</div>'.PHP_EOL;echo '</td>'.PHP_EOL;}else{echo '<td>'.$f60.'</td>'.PHP_EOL;}}echo '</tr>'.PHP_EOL;$d56=0;}}if(count($y34)===0){echo '<tr><td'.($i54>0?' colspan="'.$i54.'"':'').($e55!==''?' class="'.$e55.'"':'').'>No data</td></td>'.PHP_EOL;}}public function vm_is_active($m28){$a68=false;$m69=$this->get_vm_state($m28);if($m69==='running'||$m69==='paused'){$a68=true;}return $a68;}public function vm_is_paused($m28){$k70=false;$m69=$this->get_vm_state($m28);if($m69==='paused'){$k70=true;}return $k70;}public function ajax_response($l19,$m28){$c71=new stdClass;$c71->$w72=$l19;if(isset($m28)&&!empty($m28)){$c71->$q73=$m28;}$c71->$i74=(!is_null($l19)?true:false);return $c71;}public function send_json($l19,$z75=false){header('Content-Type: application/json');if($z75===true){echo json_encode($l19,JSON_NUMERIC_CHECK|JSON_UNESCAPED_SLASHES);}else{echo json_encode($l19);}}}?>